{
  "version": 3,
  "sources": ["../../node_modules/px.io/injectables/config.js", "../../node_modules/px.io/injectables/emitters.js", "../../node_modules/px.io/injectables/flags.js", "../../node_modules/px.io/injectables/main.http.js", "../../main.ts"],
  "sourcesContent": ["const configPath = './config.js'\nexport const configs = require(configPath).configs", "export class Emitter {\n  #CALLBACKS = {}\n  on(callback) {\n    const uuid = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {\n      const r = Math.random() * 16 | 0;\n      const v = c == 'x' ? r : (r & 0x3 | 0x8);\n      return v.toString(16)\n    })\n    this.#CALLBACKS[uuid] = callback\n    return uuid\n  }\n  off(uuid) {\n    delete this.#CALLBACKS[uuid]\n  }\n  emit(args) {\n    const callbacks = Object.values(this.#CALLBACKS)\n    for (const callback of callbacks) {\n      callback(args)\n    }\n  }\n}\nexport class Emitters {\n  #EMITTERS = new Map()\n  on(event, callback) {\n    if (!this.#EMITTERS.has(event)) {\n      this.#EMITTERS.set(event, Emitters.createEmitter())\n    }\n    return this.#EMITTERS.get(event)?.on(callback) || ''\n  }\n  off(event, uuid) {\n    this.#EMITTERS.get(event)?.off(uuid)\n  }\n  emit(event, args) {\n    this.#EMITTERS.get(event)?.emit(args)\n  }\n}\nEmitters.createEmitter = () => {\n  return new Emitter()\n}\nexport const moduleEmitters = new Emitters()", "class Flags {\n  /**\n   * Constructor.\n   */\n  constructor() {\n    const argList = process.argv\n    this.args = {}\n    let a\n    let opt\n    let thisOpt\n    let curOpt\n    for (a = 0; a < argList.length; a++) {\n      thisOpt = argList[a].trim()\n      opt = thisOpt.replace(/^\\-+/, '')\n      if (opt === thisOpt) {\n        if (curOpt) this.args[curOpt] = opt\n        curOpt = null\n      } else {\n        curOpt = opt\n        this.args[curOpt] = true\n      }\n    }\n  }\n  /**\n   * Look for a convert argument from the command line.\n   * @param {string} name Argument name.\n   * @returns {string | boolean} Returns the value of a variable.\n   */\n  get(name) {\n    return this.args[name]\n  }\n}\nexport const flags = new Flags()", "export const initHttpServer = ({ onMessage = console.log } = {}) => {\n  const configPath = './config.js'\n  const { configs } = require(configPath)\n  const httpRoutersPath = './http.js'\n  const routers = require(httpRoutersPath).default\n  const express = require('express')\n  let app = express()\n  const {\n    port = (process.env.PORT ? parseInt(process.env.PORT) : 3001),\n    dev,\n    events = {},\n    middlewares = [],\n    pathsPublic,\n    engineTemplates,\n    optionsUrlencoded,\n    createServer\n  } = configs.get('HTTP') || {}\n  app.set('port', port)\n  let externalIp = null\n  if (dev && dev.showExternalIp) {\n    const interfaces = require(\"os\").networkInterfaces()\n    if (dev.interfaceNetwork) {\n      const inter = interfaces[dev.interfaceNetwork]\n      if (inter) {\n        externalIp = inter.find(item => item.family == 'IPv4').address\n      } else {\n        console.error(`\\nLa interfaz de red \"${dev.interfaceNetwork}\" no existe!.\\nSe pueden usar las siguientes interfaces:\\n${Object.keys(interfaces).join(', ')}`)\n      }\n    } else {\n      console.error('\\nNo se defini\u00F3 una interfaz de red.\\nSe pueden usar las siguientes interfaces:\\n' + Object.keys(interfaces).join(', '))\n    }\n  }\n  if (events.beforeConfig) {\n    events.beforeConfig(app)\n  }\n  if (optionsUrlencoded) {\n    app.use(express.urlencoded(optionsUrlencoded))\n  }\n  for (const middleware of middlewares) {\n    app.use(middleware)\n  }\n  if (pathsPublic) {\n    pathsPublic.forEach(({ route, dir }) => app.use(route, express.static(dir)))\n  }\n  if (engineTemplates) {\n    app.engine(engineTemplates.ext, engineTemplates.callback)\n    app.set('views', engineTemplates.dirViews)\n    app.set('view engine', engineTemplates.name)\n  }\n  if (events.afterConfig) {\n    events.afterConfig(app)\n  }\n  app.use(express.json())\n  app.use(express.text())\n  for (const router of routers) {\n    app.use(...router)\n  }\n  if (events.onError) {\n    app.use(events.onError)\n  }\n  let server\n  if (createServer) {\n    server = createServer(app)\n  }\n  if (!server) {\n    const http = require('http')\n    server = http.createServer(app)\n  }\n  const listen = server.listen(port, () => {\n    onMessage(`Servidor corriendo en: http://localhost:${port}${externalIp ? ` y http://${externalIp}:${port}` : ''}`)\n  })\n  if (events.beforeStarting) {\n    events.beforeStarting(app)\n  }\n  process.on('SIGTERM', () => {\n    onMessage('SIGTERM signal received: closing HTTP server')\n    listen.close(() => {\n      onMessage('HTTP server closed')\n    })\n  })\n  return { http: server, app }\n}", "import cluster from \"node:cluster\"\n\nif (cluster.isPrimary) {\n  const os = require('node:os')\n  const numCPUs = os.availableParallelism()\n  console.log(`\\n\\nMaster ${process.pid} is running`, `\\n${numCPUs} workers:\\n`)\n  const Store = {\n    store: new Map(),\n    get: (sid: string) => Store.store.get(sid) || null,\n    set: (sid: string, session: any) => {\n      Store.store.set(sid, session)\n      return null\n    },\n    destroy: (sid: string) => {\n      Store.store.delete(sid)\n      return null\n    },\n    length: () => {\n      Store.store.size\n      return null\n    },\n    all: () => Array.from(Store.store.values()),\n    clear: () => Store.store.clear()\n  }\n  const PORTS = Array.from({ length: numCPUs }, (_, i) => 3000 + i)\n  for (const PORT of PORTS) {\n    const child = cluster.fork({ PORT })\n    child.on('message', message => {\n      const { uid, event, args = [] } = message\n      const e = Store[event]\n      const result = e(...args)\n      child.send({ uid, data: result })\n    })\n  }\n} else {\n  initHttpServer({ onMessage: console.log })\n}\n"],
  "mappings": "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",
  "names": ["configPath", "configs", "cluster"]
}
